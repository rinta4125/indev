<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">


  <title></title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css">
  <script src="//rawgit.com/k4r573n/leaflet-control-osm-geocoder/master/Control.OSMGeocoder.js"></script>
  <link rel="stylesheet" href="//rawgit.com/k4r573n/leaflet-control-osm-geocoder/master/Control.OSMGeocoder.css">
  <style>
    #mapid {
      height: 500px;
      width: 500px;
      margin: auto;
    }

    .center-icon {
      width: 12px !important;
      height: 12px !important;
      border-radius: 12px;
      border: 3px solid #fdfdfd;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      background-color: #1E90FF;
    }
  </style>
</head>

<body>
  <h1>☀熱中症対策アプリ☀</h1>
  <div>
    <h2 style="display:inline;">クールマップ</h2>
    <input id="mitei" type="text" />
    <button id="search">検索</button>
  </div>

  <div>
    <button class="click" id=home>ホーム</button>
    <button class="click" id="wear">コーディネート</button>
    <!--服装共有用SNS(?)に移動-->
    <button class="click" id="map">クールマップ</button>
    <!--涼が取れる施設を表示するマップに移動-->

    <table><tr>
      <td><div id="mapid"></div></td>

      <td>
		<p id="result"></p>
        <button id = "one" style="display:inline;">施設</button>
        <button id = "two" style="display:inline;">飲食</button>
        <button id = "three" style="display:inline;">ショップ</button>
        <table><tr>
        
      <table><tr>
        <td><button type="button" value="amenity@vending_machine" onclick="set_point(this.value)"><img src="map_icon/vending_machine.png" height="80" width="80" /></button></td>
        <td><button type="button" value="amenity@hospital" onclick="set_point(this.value)"><img src="map_icon/hospital.png" height="80" width="80" /></button></td>
        <td><button type="button" value="amenity@cinema" onclick="set_point(this.value)"><img src="map_icon/cinema.png" height="80" width="80" /></button></td>
      </tr></table>
      <table><tr>
        <td><button type="button" value="amenity@bench" onclick="set_point(this.value)"><img src="map_icon/bench.png" height="80" width="80" /></button></td>
        <td><button type="button" value="amenity@drinking_water" onclick="set_point(this.value)"><img src="map_icon/drinking_water.png" height="80" width="80" /></button></td>
        <td><button type="button" value="amenity@shower" onclick="set_point(this.value)"><img src="map_icon/shower.png" height="80" width="80" /></button></td>
      </tr></table>
      <table><tr>
        <td><button type="button" value="amenity@toilets" onclick="set_point(this.value)"><img src="map_icon/toilets.png" height="80" width="80" /></button></td>
        <td><button type="button" value="amenity@library" onclick="set_point(this.value)"><img src="map_icon/library.png" height="80" width="80" /></button></td>
        <td><button type="button" value="amenity@fountain" onclick="set_point(this.value)"><img src="map_icon/fountain.png" height="80" width="80" /></button></td>
      </tr></table>
        <table><tr>
        <td><button type="button" value="leisure@water_park" onclick="set_point(this.value)"><img src="map_icon/water_park.png" height="80" width="80" /></button></td>
        <td><button type="button" value="leisure@ice_rink" onclick="set_point(this.value)"><img src="map_icon/ice_rink.png" height="80" width="80" /></button></td>
      </tr></table>
    </td>

    </tr></table>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<script type="text/javascript">
	var mymap = L.map('mapid',{
	center: [35.710063, 139.8107],
	zoom: 16
	});
	
	L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
	attribution: "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors, <a href='http://creativecommons.org/licenses/by-sa/2.0/'>CC-BY-SA</a>"
	}).addTo(mymap);
	
	//スケールコントロールを最大幅200px、右下、m単位で地図に追加
	L.control.scale({ maxWidth: 200, position: 'bottomright', imperial: false }).addTo(mymap);
	
	var lat = 35;
	var lon = 135;

	async function onLocationFound(e) {
		var centerIcon = L.divIcon({ className: 'center-icon', iconAnchor: [8, 8] });
		L.marker(e.latlng, {icon: centerIcon}).addTo(mymap);
		console.log("^^");
		lat = e.latlng.lat; //緯度
		lon = e.latlng.lng; //経度
	}
	function onLocationError(e) {
		alert('位置情報を取得できませんでした。' + e.message);
	}

	mymap.on('locationfound', onLocationFound);
	mymap.on('locationerror', onLocationError);
	mymap.locate({setView: true, maxZoom: 16, timeout: 20000});

	var makerList = [];

	async function set_point(point_name){
		for (i = 0; i < makerList.length; i++){
			mymap.removeLayer(makerList[i]);
		}
		makerList = [];
		console.log(point_name);

		const response = await fetch("/search_shop", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({lat, lon, point_name})
		});

		const values = await response.text(); //場所をサーバー側から取得
		var shop_lat_list = values.split('\n')[0];
		var shop_lon_list = values.split('\n')[1];
		var shop_name_list = values.split('\n')[2];

		if (shop_lat_list.length != 0){ //場所がある場合
			var splitstr = "@@@";
			var shop_lat_list_length = ( shop_lat_list.match( new RegExp( splitstr, "g" ) ) || [] ).length + 1;
			var shop_lon_list_length = ( shop_lon_list.match( new RegExp( splitstr, "g" ) ) || [] ).length + 1;
			var shop_name_list_length = ( shop_name_list.match( new RegExp( splitstr, "g" ) ) || [] ).length + 1;

			if (shop_lat_list_length === shop_lon_list_length){
				if (shop_lon_list_length === shop_name_list_length){
					for (i = 0; i < shop_lat_list_length; i++){
						var shop_lat = shop_lat_list.split(splitstr)[i];
						var shop_lon = shop_lon_list.split(splitstr)[i];
						var shop_name = shop_name_list.split(splitstr)[i];
						
						var maker = L.marker([shop_lat, shop_lon])
							.addTo(mymap)
							.bindPopup(shop_name)
							//.openPopup();
						makerList.push(maker);
					}

				} else {
					console.log("場所情報のエラー");
				}
			} else {
				console.log("場所情報のエラー");
			}

			const result = document.querySelector("#result");
			result.innerText = makerList.length + "件見つかりました！";
		} else {
			const result = document.querySelector("#result");
			result.innerText = "該当する場所は見つかりませんでした";
		}
	}
</script>

  <p>下に施設の選択画面があってクリックすると詳細がみれる?</p>

    <script type="module">
      window.onload = async (event) => {
      };

      document.querySelector("#home").onclick = async (event) => {//homeボタンが押されたときの挙動
        location.href = 'index.html';//homeのページに移動
      }

      document.querySelector("#wear").onclick = async (event) => {//コーディネートボタンが押されたときの挙動
        location.href = 'coordination.html';//コーディネートのページに移動
      }

    </script>

    <style>
      h2 {
        color: cyan
      }
    </style>
  </div>
</body>

</html>